import pandas as pd
import numpy as np

def clean_types(df):
    for col in df.columns:
        try:
            df[col] = pd.to_numeric(df[col])
        except:
            pass
    return df

def clean_missing(df):
    for col in df.columns:
        if np.issubdtype(df[col].dtype, np.number):
            med = np.nanmedian(df[col].values)
            df[col] = np.where(df[col].isna(), med, df[col])
        else:
            df[col] = df[col].fillna("unknown")
    return df

def handle_outliers(df):
    for col in df.columns:
        if np.issubdtype(df[col].dtype, np.number):
            low = np.nanpercentile(df[col], 5)
            high = np.nanpercentile(df[col], 95)
            df[col] = np.clip(df[col], low, high)
    return df

def clean_strings_and_dates(df):
    for col in df.columns:
        if df[col].dtype == object:
            parsed = pd.to_datetime(df[col], errors="coerce", utc=True)
            if parsed.notna().sum() > 0:
                df[col] = parsed
            else:
                df[col] = (
                    df[col]
                    .str.strip()
                    .str.lower()
                    .str.replace(r"[^\w\s]", "", regex=True)
                )
    return df

def validate_cleaned(df):
    print("shape:", df.shape)
    print("missing:")
    print(np.sum(pd.isna(df), axis=0))
    return df

def clean_data(df):
    df = clean_types(df)
    df = clean_missing(df)
    df = handle_outliers(df)
    df = clean_strings_and_dates(df)
    df = validate_cleaned(df)
    return df

df = pd.read_csv("data/day14_raw.csv")
df_cleaned = clean_data(df)
print(df_cleaned.head())
